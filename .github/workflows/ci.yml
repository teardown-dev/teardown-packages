name: CI

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [develop, main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checks:
    name: Checks
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 8
    steps:
      - name: Debug - Start
        run: echo "[DEBUG] Starting CI workflow on $(uname -m)"

      - uses: actions/checkout@v4

      - name: Debug - After checkout
        run: echo "[DEBUG] Checkout complete"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Debug - After Bun setup
        run: |
          echo "[DEBUG] Bun setup complete"
          bun --version

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-${{ runner.arch }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Debug - After install
        run: echo "[DEBUG] Dependencies installed"

      - name: TypeScript Check
        timeout-minutes: 8
        run: |
          echo "[DEBUG] Starting typecheck"
          bun run typecheck
          echo "[DEBUG] Typecheck complete"

      - name: Lint & Format Check
        timeout-minutes: 8
        run: |
          echo "[DEBUG] Starting check"
          bun run check
          echo "[DEBUG] Check complete"

      - name: Run Tests
        timeout-minutes: 8
        run: |
          echo "[DEBUG] Starting tests"
          bun run test
          echo "[DEBUG] Tests complete"
