name: Nightly Publish

on:
  schedule:
    - cron: "0 23 * * *" # 23:00 UTC daily (end of UK business day)
  workflow_dispatch: # Manual trigger

env:
  TURBO_TELEMETRY_DISABLED: 1

jobs:
  nightly:
    name: Nightly Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for changes since last nightly
        id: changes
        run: |
          LAST_NIGHTLY=$(git tag -l 'nightly-*' --sort=-creatordate | head -1)
          if [ -z "$LAST_NIGHTLY" ]; then
            echo "No previous nightly tag found, will publish"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "Last nightly: $LAST_NIGHTLY"
            CHANGED=$(git diff --name-only $LAST_NIGHTLY HEAD -- packages/)
            if [ -n "$CHANGED" ]; then
              echo "Changes detected:"
              echo "$CHANGED"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "No changes in packages/ since $LAST_NIGHTLY"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: TypeScript Check
        if: steps.changes.outputs.has_changes == 'true'
        run: bun run typecheck

      - name: Lint & Format Check
        if: steps.changes.outputs.has_changes == 'true'
        run: bun run check

      - name: Run Tests
        if: steps.changes.outputs.has_changes == 'true'
        run: bun run test

      - name: Publish nightly
        if: steps.changes.outputs.has_changes == 'true'
        run: bun run scripts/nightly-publish.ts
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create nightly tag
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          TAG="nightly-$(date +%Y%m%d)"
          git tag $TAG
          git push origin $TAG
          echo "Created tag: $TAG"
