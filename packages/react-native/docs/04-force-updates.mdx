# Force Updates

Manage app version requirements and force updates with the ForceUpdateClient.

## Overview

The ForceUpdateClient automatically:
- Checks app version against your backend
- Monitors app state changes (background/foreground)
- Throttles version checks to prevent excessive API calls
- Emits version status changes for UI updates

## Version Status Types

```typescript
type VersionStatus = 
  | { type: "initializing" }      // Initial state
  | { type: "checking" }           // Currently checking version
  | { type: "up_to_date" }        // Version is current
  | { type: "update_available" }  // New version available (optional)
  | { type: "update_recommended" } // Update is recommended
  | { type: "update_required" }   // Update is required
  | { type: "disabled" }          // Version/build is disabled
```

## Using Force Updates

### Access via Hook

```typescript
import { useForceUpdate } from '@teardown/react-native';

function MyComponent() {
  const { versionStatus, isUpdateRequired, isUpdateAvailable } = useForceUpdate();
  
  if (isUpdateRequired) {
    return <UpdateRequiredScreen />;
  }
  
  if (isUpdateAvailable) {
    return <UpdateAvailableBanner />;
  }
  
  return <App />;
}
```

### Hook Return Value

```typescript
type UseForceUpdateResult = {
  versionStatus: VersionStatus;
  isUpdateAvailable: boolean;    // true if any update exists
  isUpdateRequired: boolean;     // true if update is required
}
```

## Configuration

Configure force update behavior when initializing TeardownCore:

```typescript
const teardown = new TeardownCore({
  // ... other options
  forceUpdate: {
    // Minimum time between foreground checks (default: 30000ms = 30s)
    throttleMs: 30_000,
    
    // Minimum time since last successful check (default: 300000ms = 5min)
    checkCooldownMs: 300_000,
  },
});
```

### Configuration Options

| Option | Default | Description |
|--------|---------|-------------|
| `throttleMs` | 30000 | Min milliseconds between foreground transitions before checking |
| `checkCooldownMs` | 300000 | Min milliseconds since last successful check before re-checking |

## How It Works

### Automatic Checks

The SDK automatically checks version in these scenarios:

1. **Initial Identification**
   - When the SDK initializes
   - When `identify()` is called
   
2. **App Foreground**
   - When app returns from background
   - Subject to throttle and cooldown timers

### Check Flow

```
App goes to foreground
  ↓
Check throttle timer (last foreground < throttleMs ago?)
  ↓ No
Check cooldown timer (last check < checkCooldownMs ago?)
  ↓ No
Call identify() to refresh version status
  ↓
Update version status
  ↓
Emit VERSION_STATUS_CHANGED event
```

### Throttle vs Cooldown

- **Throttle**: Prevents checks when rapidly switching apps
- **Cooldown**: Prevents excessive API calls even with long background periods

Example:
```typescript
// User switches between apps rapidly:
// 10:00:00 - Foreground (check)
// 10:00:05 - Foreground (throttled - too soon)
// 10:00:45 - Foreground (check - passed throttle)
// 10:00:50 - Foreground (cooldown - last check < 5min ago)
```

## Building Update UI

### Required Update Screen

```typescript
function UpdateRequiredScreen() {
  const { isUpdateRequired, versionStatus } = useForceUpdate();
  
  if (!isUpdateRequired) return null;
  
  return (
    <View style={styles.container}>
      <Text>Update Required</Text>
      <Text>Please update to continue using the app</Text>
      <Button 
        title="Update Now" 
        onPress={() => Linking.openURL('market://details?id=com.yourapp')}
      />
    </View>
  );
}
```

### Optional Update Banner

```typescript
function UpdateBanner() {
  const { isUpdateAvailable, isUpdateRequired } = useForceUpdate();
  const [dismissed, setDismissed] = useState(false);
  
  // Don't show if required (use dedicated screen)
  if (isUpdateRequired || !isUpdateAvailable || dismissed) {
    return null;
  }
  
  return (
    <View style={styles.banner}>
      <Text>A new version is available</Text>
      <Button title="Update" onPress={handleUpdate} />
      <Button title="Later" onPress={() => setDismissed(true)} />
    </View>
  );
}
```

### Full-Screen Takeover

Example from the SDK:

```typescript
function FullscreenTakeover() {
  const { isUpdateRequired } = useForceUpdate();
  
  if (!isUpdateRequired) return null;
  
  return (
    <Modal visible={true} animationType="fade">
      <UpdateRequiredScreen />
    </Modal>
  );
}

// In your layout
<TeardownProvider core={teardown}>
  <App />
  <FullscreenTakeover />
</TeardownProvider>
```

## Listening to Status Changes

### Via Hook (Recommended)

```typescript
const { versionStatus } = useForceUpdate();

useEffect(() => {
  console.log('Version status:', versionStatus.type);
}, [versionStatus]);
```

### Via Event Listener

```typescript
import { useTeardown } from '@teardown/react-native';

function MyComponent() {
  const { core } = useTeardown();
  
  useEffect(() => {
    const unsubscribe = core.forceUpdate.onVersionStatusChange((status) => {
      console.log('Status changed:', status.type);
      
      if (status.type === 'update_required') {
        // Show update UI
      }
    });
    
    return unsubscribe;
  }, []);
}
```

## Getting Current Status

```typescript
// Via hook (reactive)
const { versionStatus } = useForceUpdate();

// Via client (direct)
const status = core.forceUpdate.getVersionStatus();
```

## Platform-Specific Store Links

### iOS

```typescript
const APP_STORE_ID = 'your-app-id';
const APP_STORE_URL = `https://apps.apple.com/app/id${APP_STORE_ID}`;

<Button 
  title="Update" 
  onPress={() => Linking.openURL(APP_STORE_URL)} 
/>
```

### Android

```typescript
const PACKAGE_NAME = 'com.yourcompany.yourapp';
const PLAY_STORE_URL = `market://details?id=${PACKAGE_NAME}`;
const PLAY_STORE_WEB = `https://play.google.com/store/apps/details?id=${PACKAGE_NAME}`;

const handleUpdate = async () => {
  const supported = await Linking.canOpenURL(PLAY_STORE_URL);
  const url = supported ? PLAY_STORE_URL : PLAY_STORE_WEB;
  Linking.openURL(url);
};
```

### Cross-Platform

```typescript
import { Platform, Linking } from 'react-native';

const STORE_URL = Platform.select({
  ios: 'https://apps.apple.com/app/id123456789',
  android: 'market://details?id=com.yourapp',
  default: 'https://yourapp.com/download',
});

<Button 
  title="Update Now" 
  onPress={() => Linking.openURL(STORE_URL)} 
/>
```

## Version Status in Backend

Version status is determined by your backend configuration:

- `UP_TO_DATE`: Current version matches or is newer than minimum
- `UPDATE_AVAILABLE`: New version exists, but not required
- `UPDATE_RECOMMENDED`: New version exists, recommended to update
- `UPDATE_REQUIRED`: Current version is below minimum required
- `DISABLED`: This specific version/build is disabled

Configure these in your Teardown dashboard under project settings.

## Best Practices

### 1. Use Full-Screen Takeover for Required Updates

```typescript
// ✅ Good - blocks app usage
{isUpdateRequired && <UpdateRequiredModal />}

// ❌ Bad - user can dismiss and continue with outdated version
{isUpdateRequired && <UpdateBanner dismissible />}
```

### 2. Make Optional Updates Dismissible

```typescript
// ✅ Good - user can choose when to update
{isUpdateAvailable && !isUpdateRequired && <DismissibleBanner />}
```

### 3. Respect User Decisions

```typescript
// ✅ Good - remember dismissal for session
const [dismissed, setDismissed] = useState(false);

// ❌ Bad - annoying the user every render
{isUpdateAvailable && <Banner />}
```

### 4. Provide Clear CTAs

```typescript
// ✅ Good - clear action
<Button title="Update Now" onPress={openStore} />

// ❌ Bad - vague
<Button title="OK" onPress={openStore} />
```

## Next Steps

- [Device Information](./05-device-info.mdx)
- [Hooks Reference](./08-hooks-reference.mdx)
- [Advanced Usage](./09-advanced.mdx)
